---
title: "Blog-post2"
subtitle: "ETC5523: Communicating with Data - Assessement"
author: "Priscila Grecov"
date: "17/09/2020"
output: html_document
---

```{r setup, include = FALSE}
library(tidyverse)
library(sparkline)
library(DT)
library(stargazer)
library(knitr)
library(kableExtra)
library(broom)
library(tidycat)
library(scales)
library(dplyr)
library(ggplot2)
library(plotly)
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
select <- dplyr::select
```


## Exploring COVID-19 daily data for Portugal

<br>  

### 1. Introduction 



<br> 

### 2. Data Description
  


<br> 

### 3. Data Analysis  



<br> 
  
```{r portugal-dataset1}
dt2_COVID <- read.csv("owid-covid-data.csv")
PORT_df2 <- dt2_COVID %>%
  filter(location == "Portugal") 
PORT_df2_B <- PORT_df2[-(185:186),]
PORT_df2_B <- PORT_df2_B[-(1:2),]
PORT_df2_B$date2 <- as.Date(PORT_df2_B$date)
PORT_df2_B$Month <- months(PORT_df2_B$date2)
PORT_df2_B$Month = factor(PORT_df2_B$Month, levels=c('February','March','April','May','June','July','August'))
```

```{r set1-graphs-cases&deaths, fig.dim = c(30, 10), fig.align='center'}
library(patchwork)

bar_cases <- PORT_df2_B %>%
  ggplot(aes(x=date2)) +
  geom_col(aes(y=new_cases), color="darkblue") + 
  geom_line(aes(y=total_cases*.04), size = 1.5, color="purple") +
  theme(legend.position="none") +
  scale_y_continuous(sec.axis = sec_axis(~./0.04, labels = scales::label_comma(), breaks=seq(0, 75000, 12500),
                                         name = "total accumulated cases"), 
                     labels = scales::label_comma()) +
  scale_x_date(date_labels = "%d-%m", date_breaks  ="5 days") +
  theme(axis.text.x = element_text(angle=60, hjust=1, size = 20, color = 'darkblue'),
        axis.text.y = element_text(size = 25,  color = 'darkblue'),
        axis.title.y = element_text(size = 25, color = 'darkblue', face = "bold"),
        plot.title = element_text(size = 35, face = "bold", color = 'darkblue')) +
  ylab('daily qty of new cases') +
  xlab("") +
  #xlim(c("2020-03-03","2020-08-31")) +
  labs(title='Evolution of cases')


bar_deaths <- PORT_df2_B %>%
  ggplot(aes(x=date2)) +
  geom_col(aes(y=new_deaths), color="darkred") + 
  geom_line(aes(y=total_deaths*.04), size = 1.5, color="darkorange") +
  theme(legend.position="none") +
  scale_y_continuous(sec.axis = sec_axis(~./0.04, labels = scales::label_comma(),
                                         name = "total accumulated deaths"), 
                     labels = scales::label_comma()) +
  scale_x_date(date_labels = "%d-%m", date_breaks  ="5 days") +
  theme(axis.text.x=element_text(angle=60, hjust=1, size = 20, color="darkred"),
        axis.text.y = element_text(size = 25, color="darkred"),
        axis.title.y = element_text(size = 25, color = 'darkred', face = "bold"),
        plot.title = element_text(size = 35, face = "bold", color = 'darkred')) +
  ylab('daily qty of new deaths') +
  xlab("") +
  #xlim(c("2020-03-03","2020-08-31")) +
  labs(title='Evolution of deaths')

# bar_cases
# bar_deaths

bar_cases + bar_deaths + plot_layout(widths = 50, guides = "collect")
```
```{r set2-graphs-rates, fig.align="center", fig.dim = c(20, 7)}
library(ggridges)
library(tidyverse)
library(hrbrthemes)
library(viridis)
library(patchwork)

h1 <- ggplot(PORT_df2_B, aes(x = positive_rate, y = Month, fill = Month)) + 
  ggridges::geom_density_ridges(scale = 4) +
  # ggridges::geom_density_ridges(scale = 4, alpha=0.6, stat="binline", bins=30) +
  theme_ridges(font_size = 17) + 
  labs(tag = "(B)", title = 'Positive Rate of cases per tests executed (%)') +
  ylab("") +
  theme(legend.position = "none")

h2 <- ggplot(PORT_df2_B, aes(x = tests_per_case, y = Month, fill = Month)) + 
  ggridges::geom_density_ridges(scale = 4) +
  #ggridges::geom_density_ridges(scale = 4, alpha=0.6, stat="binline", bins=20) +
  theme_ridges(font_size = 17) + 
  labs(tag = "(A)", title = 'Tests executed per case detected') +
  ylab("") +
  theme(legend.position = "none")
# h1
# h2

PORT_df2_B$mortality_rate <- round((PORT_df2_B$new_deaths_per_million/PORT_df2_B$new_cases_per_million)*100,2)

h3 <- ggplot(PORT_df2_B, aes(x = mortality_rate, y = Month, fill = Month)) + 
  ggridges::geom_density_ridges(scale = 4) +
  # ggridges::geom_density_ridges(scale = 4, alpha=0.6, stat="binline", bins=30) +
  theme_ridges(font_size = 17) + 
  labs(tag = "(C)", title = 'Mortality rate per million of habitants (%)') +
  ylab("") +
  theme(legend.position = "none")
# h3

h2 + h1 + h3 + plot_layout(widths = 40, guides = "collect")
```



```{r portugal-dataset2-subnationl, include=FALSE}
dt_COVID_subnt <- read.csv("jrc-covid-19-regions-hxl.csv")
dt_COVID_subnt <- dt_COVID_subnt[-1,]
dt_COVID_subnt_PRT <- dt_COVID_subnt %>%
  filter(CountryName == "Portugal") 
dt_COVID_subnt_PRT$Date2 <- as.Date(dt_COVID_subnt_PRT$Date)
dt_COVID_subnt_PRT$CumulativePositive <- as.numeric(dt_COVID_subnt_PRT$CumulativePositive)
dt_COVID_subnt_PRT$CumulativeDeceased <- as.numeric(dt_COVID_subnt_PRT$CumulativeDeceased)
dt_COVID_subnt_PRT$CumulativeRecovered <- as.numeric(dt_COVID_subnt_PRT$CumulativeRecovered)
dt_COVID_subnt_PRT$CurrentlyPositive <- as.numeric(dt_COVID_subnt_PRT$CurrentlyPositive)
dt_COVID_subnt_PRT$Hospitalized <- as.numeric(dt_COVID_subnt_PRT$Hospitalized)
dt_COVID_subnt_PRT$IntensiveCare <- as.numeric(dt_COVID_subnt_PRT$IntensiveCare)
unique(dt_COVID_subnt_PRT$Region)
unique(dt_COVID_subnt_PRT$NUTS)
```

```{r adjusting-dataset2, include=FALSE}
dt_COVID_subnt_PRT_ready <- dt_COVID_subnt_PRT %>%
    group_by(Date2, Region, lat, lon) %>%
    summarize(Tot_Positive = sum(CumulativePositive),
              Tot_Deaths = sum(CumulativeDeceased),
              Tot_Recover = sum(CumulativeRecovered),
              Curr_Positive = sum(CurrentlyPositive),
              Hosp = sum(Hospitalized),
              IntCare = sum(IntensiveCare),
              .groups = 'drop')

dt_COVID_subnt_PRT_ready %>%
  select(Date2, Region, Tot_Positive) 
```

```{r set3-graphs-linesPerRegion, fig.dim = c(10, 4)}

graphLine_Region_cases <- dt_COVID_subnt_PRT_ready %>%
  select(Date2, Region, Tot_Positive) %>%
  filter(Region %in% c("Açores", "Alentejo", "Algarve", "Centro", "Lisbon", "Madeira", "Norte")) %>%
  ggplot(aes(x = Date2, y = Tot_Positive)) +
  geom_line(aes(color = Region), size=1.4) +
  scale_color_ipsum() +
  xlab("") +
  ylab("total number of cases") +
  scale_x_date(date_labels = "%d-%m", date_breaks  ="10 days") +
  scale_y_continuous(labels = scales::label_comma(), breaks = seq(0, 40000, by=5000)) +
  #theme_ipsum() +
  theme_bw(base_size = 11) +
  theme(axis.text.x=element_text(angle=60, hjust=1, size = 10),
        plot.title = element_text(size = 15, face = "bold", color = 'darkblue')) +
  labs(title = "Total cases per Region", size = 15) 

ggplotly(graphLine_Region_cases) %>%
  config(displayModeBar = F)

graphLine_Region_deaths <- dt_COVID_subnt_PRT_ready %>%
  select(Date2, Region, Tot_Deaths) %>%
  filter(Region %in% c("Açores", "Alentejo", "Algarve", "Centro", "Lisbon", "Madeira", "Norte")) %>%
  filter(Date2 > "2020-03-20") %>%
  ggplot(aes(x = Date2, y = Tot_Deaths)) +
  geom_line(aes(color = Region), size=1.4) +
  scale_color_ipsum() +
  xlab("") +
  ylab("total number of deaths") +
  scale_x_date(date_labels = "%d-%m", date_breaks  ="10 days") +
  scale_y_continuous(labels = scales::label_comma(),  breaks = seq(0, 900, by=150)) +
  #theme_ipsum() +
  theme_bw(base_size = 11) +
  theme(axis.text.x=element_text(angle=60, hjust=1, size = 10),
        plot.title = element_text(size = 15, face = "bold", color = 'darkblue')) +
  labs(title = "Total deaths per Region") 

ggplotly(graphLine_Region_deaths) %>%
  config(displayModeBar = F)

#grid.arrange(graphLine_Region_cases, graphLine_Region_deaths, nrow = 2)
```

```{r bubblemap-Region-totalcases}
# bubble map with total cases
```

```{r}
#unique(port_adm$GID_1)
#unique(port_adm$NAME_1)
#unique(port_adm$VARNAME_1)
#unique(port_adm$CC_1) # maybe this is the one equivalent to regions
#unique(port_adm$HASC_1)
```

```{r}
#port_map <- fortify(port_adm, region="NAME_1")

#port_adm %>%
#  group_by(CC_1, NAME_1) %>%
#  summarise(n(), )
```
